# Тестирование AI-виртуального консультанта

## Обзор

Полный набор тестов для проверки функциональности AI-виртуального консультанта (чат-бота).

## Структура тестов

### 1. API тесты (`test_chat_api.py`)

Полное покрытие API эндпоинта `/api/v1/chat/message`:

- ✅ **Проверка промпта** - наличие промпта `chat_consultant_prompt` в prompts-manager
- ✅ **Проверка эндпоинта** - существование и доступность эндпоинта
- ✅ **Формат ответа** - корректность структуры ответа API
- ✅ **Чат с историей** - работа с историей диалога
- ✅ **Контекст пластинки** - работа с `current_product_id`
- ✅ **Очистка markdown** - проверка удаления markdown-символов
- ✅ **Валидация запроса** - обработка неверных данных
- ✅ **Обработка ошибок** - корректная обработка ошибок

**Запуск:**
```bash
python tests/test_chat_api.py
```

### 2. Фронтенд тесты (`test_chat_frontend.html`)

Интерактивные тесты для проверки UI и функциональности на клиентской стороне:

- ✅ **Элементы интерфейса** - наличие всех необходимых элементов
- ✅ **Инициализация** - правильная инициализация модуля чата
- ✅ **Отправка сообщений** - работа отправки сообщений
- ✅ **Сохранение истории** - работа localStorage
- ✅ **Очистка истории** - функция очистки
- ✅ **Доступность API** - проверка подключения к сервисам
- ✅ **Запросы к API** - корректность запросов
- ✅ **Обработка ошибок** - обработка ошибок на фронтенде
- ✅ **UI/UX** - открытие/закрытие, индикаторы, форматирование

**Запуск:**
Откройте `tests/test_chat_frontend.html` в браузере

## Предварительные требования

Для запуска тестов необходимо:

1. **Запустить все сервисы:**
   ```bash
   python start_services_final.py
   ```

2. **Убедиться, что сервисы доступны:**
   - Catalog: http://127.0.0.1:8000/health
   - Recommender: http://127.0.0.1:8004/health
   - Prompts Manager: http://127.0.0.1:8007/health

3. **Проверить наличие API ключа:**
   - В `config.env` должен быть установлен `OPENROUTER_API_KEY`

## Результаты тестирования

### Успешное выполнение

Все тесты должны пройти успешно:
- ✅ API тесты: 8/8 пройдено
- ✅ Фронтенд тесты: 9/9 пройдено

### Возможные проблемы

1. **Сервисы не запущены:**
   - Ошибка: `ERR_CONNECTION_REFUSED`
   - Решение: Запустите сервисы через `start_services_final.py`

2. **Отсутствует API ключ:**
   - Ошибка: `OPENROUTER_API_KEY не установлен`
   - Решение: Добавьте ключ в `config.env`

3. **Таймаут LLM:**
   - Ошибка: `Timeout при обращении к эндпоинту`
   - Решение: Проверьте подключение к интернету и доступность OpenRouter

4. **Пустой каталог:**
   - Ошибка: `Каталог пуст`
   - Решение: Убедитесь, что в каталоге есть товары

## Детали тестов

### API тесты

#### test_prompts_manager_has_chat_prompt
Проверяет наличие промпта `chat_consultant_prompt` в prompts-manager.

**Ожидаемый результат:** Промпт найден и содержит поле `template`.

#### test_chat_endpoint_exists
Проверяет существование и доступность эндпоинта `/api/v1/chat/message`.

**Ожидаемый результат:** Эндпоинт доступен (статус 200 или ошибка сервиса, но не 404).

#### test_chat_response_format
Проверяет формат ответа API.

**Ожидаемый результат:** Ответ содержит поля `response` (str) и `success` (bool).

#### test_chat_with_history
Проверяет работу чата с историей диалога.

**Ожидаемый результат:** Ответ содержит информацию о пластинках рока.

#### test_chat_with_current_product
Проверяет работу чата с контекстом текущей пластинки.

**Ожидаемый результат:** Ответ учитывает информацию о текущей пластинке.

#### test_chat_markdown_cleaning
Проверяет очистку markdown-символов из ответов.

**Ожидаемый результат:** В ответе нет markdown-символов (`**`, `##`, ```` и т.д.).

#### test_chat_request_validation
Проверяет валидацию входящих запросов.

**Ожидаемый результат:** 
- Пустые сообщения отклоняются (422)
- Неверный формат истории отклоняется (422)

#### test_chat_error_handling
Проверяет обработку ошибок.

**Ожидаемый результат:** Несуществующий `current_product_id` обрабатывается корректно.

### Фронтенд тесты

Все тесты выполняются в браузере и проверяют:
- Наличие элементов DOM
- Работу функций JavaScript
- Интеграцию с API
- Сохранение данных в localStorage
- UI/UX элементы

## Запуск всех тестов

Для полного тестирования запустите:

```bash
# API тесты
python tests/test_chat_api.py

# Фронтенд тесты (откройте в браузере)
start tests/test_chat_frontend.html
```

## Отчеты

После выполнения тестов вы увидите:
- Статус каждого теста (✅ ПРОЙДЕН / ❌ ПРОВАЛЕН)
- Общее количество пройденных тестов
- Детали ошибок (если есть)

## Интеграция с CI/CD

Тесты можно интегрировать в CI/CD pipeline:

```bash
# В скрипте CI/CD
python tests/test_chat_api.py
if [ $? -ne 0 ]; then
    echo "Тесты не пройдены"
    exit 1
fi
```

## Дополнительные тесты

### Ручное тестирование

Рекомендуется также провести ручное тестирование:

1. Откройте главную страницу
2. Нажмите на кнопку чата
3. Отправьте несколько сообщений
4. Проверьте сохранение истории
5. Проверьте очистку истории
6. Проверьте работу на странице детализации

### Тестирование производительности

Для проверки производительности можно:
- Отправить несколько запросов подряд
- Проверить время ответа
- Проверить использование памяти

## Поддержка

Если тесты не проходят:
1. Проверьте логи сервисов в папке `logs/`
2. Проверьте консоль браузера (F12)
3. Убедитесь, что все зависимости установлены
4. Проверьте конфигурацию в `config.env`

