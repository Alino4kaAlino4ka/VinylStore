<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –ø—Ä–æ–º–ø—Ç–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #121212;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #1a1a1a;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #ff6b35;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }
        
        h2 {
            color: #ff6b35;
            margin: 20px 0;
            font-size: 18px;
        }
        
        .test-section {
            background: #252525;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: 600;
        }
        
        .test-result.success {
            background: #28a745;
            color: white;
        }
        
        .test-result.error {
            background: #dc3545;
            color: white;
        }
        
        .test-result.info {
            background: #007bff;
            color: white;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 5px;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .prompt-card {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #333;
        }
        
        .prompt-label {
            color: #ff6b35;
            font-weight: 600;
            margin-bottom: 10px;
            display: block;
        }
        
        textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #1a1a1a;
            color: #e0e0e0;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            resize: vertical;
            margin-bottom: 10px;
        }
        
        .log {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #667eea;
            padding-left: 10px;
        }
        
        .log-entry.error {
            border-left-color: #dc3545;
            color: #ff6b6b;
        }
        
        .log-entry.success {
            border-left-color: #28a745;
            color: #51cf66;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –ø—Ä–æ–º–ø—Ç–æ–≤</h1>
        
        <div class="test-section">
            <h2>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API</h2>
            <button onclick="testAPIHealth()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å health check</button>
            <div id="health-result"></div>
        </div>
        
        <div class="test-section">
            <h2>2. –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤</h2>
            <button onclick="testLoadPrompts()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–º–ø—Ç—ã</button>
            <div id="load-result"></div>
            <div id="prompts-container"></div>
        </div>
        
        <div class="test-section">
            <h2>3. –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞</h2>
            <button onclick="testUpdatePrompt()">–¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</button>
            <div id="update-result"></div>
        </div>
        
        <div class="test-section">
            <h2>4. –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫</h2>
            <button onclick="testErrorHandling()">–¢–µ—Å—Ç –æ—à–∏–±–æ–∫</button>
            <div id="error-result"></div>
        </div>
        
        <div class="test-section">
            <h2>5. –õ–æ–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h2>
            <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8007';
        let originalPromptContent = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${type}">${message}</div>`;
        }
        
        async function testAPIHealth() {
            log('–ù–∞—á–∞–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ health check...', 'info');
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (response.ok && data.status === 'ok') {
                    showResult('health-result', '‚úÖ Health check: PASSED', 'success');
                    log('Health check —É—Å–ø–µ—à–µ–Ω', 'success');
                } else {
                    showResult('health-result', '‚ùå Health check: FAILED', 'error');
                    log('Health check –ø—Ä–æ–≤–∞–ª–µ–Ω', 'error');
                }
            } catch (error) {
                showResult('health-result', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                log(`–û—à–∏–±–∫–∞ health check: ${error.message}`, 'error');
            }
        }
        
        async function testLoadPrompts() {
            log('–ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤...', 'info');
            const container = document.getElementById('prompts-container');
            container.innerHTML = '<div style="color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/prompts`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const prompts = await response.json();
                
                if (prompts.length === 0) {
                    showResult('load-result', '‚ö†Ô∏è –ü—Ä–æ–º–ø—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'info');
                    container.innerHTML = '<div style="color: #666;">–ü—Ä–æ–º–ø—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</div>';
                    log('–ü—Ä–æ–º–ø—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'info');
                    return;
                }
                
                showResult('load-result', `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–æ–º–ø—Ç–æ–≤: ${prompts.length}`, 'success');
                log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${prompts.length} –ø—Ä–æ–º–ø—Ç–æ–≤`, 'success');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Ç–µ—Å—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                if (prompts.length > 0) {
                    originalPromptContent = prompts[0].content;
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–æ–º–ø—Ç—ã
                container.innerHTML = '';
                prompts.forEach(prompt => {
                    const card = document.createElement('div');
                    card.className = 'prompt-card';
                    card.innerHTML = `
                        <label class="prompt-label">${prompt.name}</label>
                        <textarea readonly style="opacity: 0.8;">${prompt.content || ''}</textarea>
                        <small style="color: #666;">ID: ${prompt.id} | –°–æ–∑–¥–∞–Ω: ${prompt.created_at || 'N/A'}</small>
                    `;
                    container.appendChild(card);
                });
                
            } catch (error) {
                showResult('load-result', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                container.innerHTML = `<div style="color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
                log(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`, 'error');
            }
        }
        
        async function testUpdatePrompt() {
            log('–ù–∞—á–∞–ª–æ —Ç–µ—Å—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞...', 'info');
            
            try {
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–º–ø—Ç
                const getResponse = await fetch(`${API_BASE}/api/v1/prompts/recommendation_prompt`);
                
                if (!getResponse.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–º–ø—Ç');
                }
                
                const currentPrompt = await getResponse.json();
                const originalContent = currentPrompt.content;
                
                log(`–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç: ${originalContent.substring(0, 50)}...`, 'info');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–º–ø—Ç
                const testContent = `–¢–ï–°–¢–û–í–´–ô –ü–†–û–ú–ü–¢ - ${new Date().toISOString()}`;
                const updateResponse = await fetch(`${API_BASE}/api/v1/prompts/recommendation_prompt`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: testContent
                    })
                });
                
                if (!updateResponse.ok) {
                    throw new Error(`HTTP ${updateResponse.status}`);
                }
                
                const updated = await updateResponse.json();
                
                if (updated.content === testContent) {
                    log('–ü—Ä–æ–º–ø—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
                    const restoreResponse = await fetch(`${API_BASE}/api/v1/prompts/recommendation_prompt`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            content: originalContent
                        })
                    });
                    
                    if (restoreResponse.ok) {
                        showResult('update-result', '‚úÖ –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: PASSED (–∫–æ–Ω—Ç–µ–Ω—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)', 'success');
                        log('–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'success');
                    } else {
                        showResult('update-result', '‚ö†Ô∏è –ü—Ä–æ–º–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω, –Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å', 'error');
                        log('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞', 'error');
                    }
                } else {
                    throw new Error('–ö–æ–Ω—Ç–µ–Ω—Ç –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç');
                }
                
            } catch (error) {
                showResult('update-result', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                log(`–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }
        
        async function testErrorHandling() {
            log('–ù–∞—á–∞–ª–æ —Ç–µ—Å—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫...', 'info');
            
            try {
                // –¢–µ—Å—Ç 1: –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–º–ø—Ç
                const response1 = await fetch(`${API_BASE}/api/v1/prompts/nonexistent_prompt_12345`);
                if (response1.status === 404) {
                    log('‚úÖ 404 –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ', 'success');
                } else {
                    log('‚ùå 404 –æ—à–∏–±–∫–∞ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞', 'error');
                }
                
                // –¢–µ—Å—Ç 2: –ü—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—è)
                const response2 = await fetch(`${API_BASE}/api/v1/prompts/recommendation_prompt`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: ''
                    })
                });
                
                if (!response2.ok) {
                    log('‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—É—Å—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success');
                } else {
                    log('‚ö†Ô∏è –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—É—Å—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞', 'info');
                }
                
                showResult('error-result', '‚úÖ –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω (—Å–º. –ª–æ–≥)', 'success');
                
            } catch (error) {
                showResult('error-result', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                log(`–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫: ${error.message}`, 'error');
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('DOMContentLoaded', () => {
            log('–¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'info');
            log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞...', 'info');
            testAPIHealth();
        });
    </script>
</body>
</html>

