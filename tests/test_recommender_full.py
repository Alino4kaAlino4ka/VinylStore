#!/usr/bin/env python3
"""
–ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç —Å–µ—Ä–≤–∏—Å–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —Å –º–æ–∫-–¥–∞–Ω–Ω—ã–º–∏
"""
import asyncio
import httpx
import json
import os
from pathlib import Path
from openai import OpenAI

def load_config():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ —Ñ–∞–π–ª–∞ config.env"""
    config = {}
    config_path = Path(__file__).parent.parent / 'config.env'
    try:
        with open(config_path, 'r', encoding='utf-8') as f:
            for line in f:
                line = line.strip()
                if line and not line.startswith('#') and '=' in line:
                    key, value = line.split('=', 1)
                    config[key] = value
    except FileNotFoundError:
        print("‚ùå –§–∞–π–ª config.env –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return None
    return config

async def test_recommender_with_mock_data():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Å–µ—Ä–≤–∏—Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —Å –º–æ–∫-–¥–∞–Ω–Ω—ã–º–∏ –∫–∞—Ç–∞–ª–æ–≥–∞"""
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —Å –º–æ–∫-–¥–∞–Ω–Ω—ã–º–∏...")
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    config = load_config()
    if not config:
        return False
    
    api_key = config.get('OPENROUTER_API_KEY')
    if not api_key:
        print("‚ùå OPENROUTER_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏!")
        return False
    
    try:
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç OpenAI –¥–ª—è –ø—Ä—è–º–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        client = OpenAI(
            api_key=api_key,
            base_url="https://openrouter.ai/api/v1"
        )
        
        # –ú–æ–∫-–¥–∞–Ω–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∞ –≤–∏–Ω–∏–ª–æ–≤—ã—Ö –ø–ª–∞—Å—Ç–∏–Ω–æ–∫
        mock_records = [
            {
                "id": 1,
                "name": "Abbey Road",
                "artist": "The Beatles",
                "description": "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –∞–ª—å–±–æ–º The Beatles 1969 –≥–æ–¥–∞ —Å –∫—É–ª—å—Ç–æ–≤–æ–π –æ–±–ª–æ–∂–∫–æ–π –∏ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–º–∏ –∫–æ–º–ø–æ–∑–∏—Ü–∏—è–º–∏",
                "price": 2999.0,
                "cover_url": "https://example.com/abbey_road.jpg"
            },
            {
                "id": 2,
                "name": "The Dark Side of the Moon",
                "artist": "Pink Floyd",
                "description": "–ó–Ω–∞–∫–æ–≤—ã–π –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—ã–π –∞–ª—å–±–æ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–≥–æ —Ä–æ–∫–∞ 1973 –≥–æ–¥–∞",
                "price": 2499.0,
                "cover_url": "https://example.com/dark_side.jpg"
            },
            {
                "id": 3,
                "name": "Led Zeppelin IV",
                "artist": "Led Zeppelin",
                "description": "–ö—É–ª—å—Ç–æ–≤—ã–π –∞–ª—å–±–æ–º —Ö–∞—Ä–¥-—Ä–æ–∫–∞ —Å –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–π –∫–æ–º–ø–æ–∑–∏—Ü–∏–µ–π Stairway to Heaven",
                "price": 1999.0,
                "cover_url": "https://example.com/led_zeppelin_iv.jpg"
            },
            {
                "id": 4,
                "name": "A Night at the Opera",
                "artist": "Queen",
                "description": "–≠–ø–∏—á–µ—Å–∫–∏–π —Ä–æ–∫-–∞–ª—å–±–æ–º —Å –æ–ø–µ—Ä–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –∏ —Ö–∏—Ç-—Å–∏–Ω–≥–ª–æ–º Bohemian Rhapsody",
                "price": 3499.0,
                "cover_url": "https://example.com/night_at_opera.jpg"
            },
            {
                "id": 5,
                "name": "Highway to Hell",
                "artist": "AC/DC",
                "description": "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ä–æ–∫-–∞–ª—å–±–æ–º —Å –º–æ—â–Ω—ã–º–∏ –≥–∏—Ç–∞—Ä–Ω—ã–º–∏ —Ä–∏—Ñ—Ñ–∞–º–∏ –∏ —ç–Ω–µ—Ä–≥–∏—á–Ω—ã–º–∏ –∫–æ–º–ø–æ–∑–∏—Ü–∏—è–º–∏",
                "price": 2199.0,
                "cover_url": "https://example.com/highway_to_hell.jpg"
            }
        ]
        
        print(f"üíø –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–∫-–∫–∞—Ç–∞–ª–æ–≥ —Å {len(mock_records)} –≤–∏–Ω–∏–ª–æ–≤—ã–º–∏ –ø–ª–∞—Å—Ç–∏–Ω–∫–∞–º–∏")
        
        # –°–æ–∑–¥–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        records_list = "\n".join([
            f"ID: {record['id']} | –ù–∞–∑–≤–∞–Ω–∏–µ: {record['name']} | –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: {record['artist']} | –û–ø–∏—Å–∞–Ω–∏–µ: {record['description'][:100]}... | –¶–µ–Ω–∞: {record['price']}‚ÇΩ"
            for record in mock_records
        ])
        
        system_prompt = f"""
# –°–ò–°–¢–ï–ú–ê AI-–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô –í–ò–ù–ò–õ–û–í–´–• –ü–õ–ê–°–¢–ò–ù–û–ö

## –†–û–õ–¨
–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –≤–∏–Ω–∏–ª–æ–≤—ã–º –ø–ª–∞—Å—Ç–∏–Ω–∫–∞–º —Å –≥–ª—É–±–æ–∫–∏–º –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º –º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö –∂–∞–Ω—Ä–æ–≤, –∏—Å—Ç–æ—Ä–∏–∏ –º—É–∑—ã–∫–∏ –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä–æ–≤. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∫–∞—Ç–∞–ª–æ–≥–∞ –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

## –ö–ê–¢–ê–õ–û–ì –î–û–°–¢–£–ü–ù–´–• –í–ò–ù–ò–õ–û–í–´–• –ü–õ–ê–°–¢–ò–ù–û–ö
{records_list}

## –ê–õ–ì–û–†–ò–¢–ú –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô
1. **–ê–Ω–∞–ª–∏–∑ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π**: –ò–∑—É—á–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∂–∞–Ω—Ä—ã –∏ —Ç–µ–∫—É—â–∏–µ –ø–ª–∞—Å—Ç–∏–Ω–∫–∏
2. **–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑**: –ù–∞–π–¥–∏ –ø–ª–∞—Å—Ç–∏–Ω–∫–∏ —Å –ø–æ—Ö–æ–∂–∏–º–∏ —Å—Ç–∏–ª—è–º–∏, —ç–ø–æ—Ö–æ–π –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º
3. **–î–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è**: –ü—Ä–µ–¥–ª–æ–∂–∏ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏
4. **–¶–µ–Ω–æ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –£—á–∏—Ç—ã–≤–∞–π –±—é–¥–∂–µ—Ç–Ω—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
5. **–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –ü–æ–¥–±–µ—Ä–∏ –ø–ª–∞—Å—Ç–∏–Ω–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–∑–æ–≤—É—Ç –Ω—É–∂–Ω—ã–µ —ç–º–æ—Ü–∏–∏

## –ü–†–ï–î–ü–û–ß–¢–ï–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
- –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: –õ—é–±–ª—é –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ä–æ–∫ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Ä–æ–∫
- –¢–µ–∫—É—â–∏–µ –ø–ª–∞—Å—Ç–∏–Ω–∫–∏: 1, 2
- –õ—é–±–∏–º—ã–µ –∂–∞–Ω—Ä—ã: –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ä–æ–∫, –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Ä–æ–∫, —Ö–∞—Ä–¥-—Ä–æ–∫
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π: 3

## –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê
–í–µ—Ä–Ω–∏ JSON —Å –ø–æ–ª—è–º–∏:
- recommendations: –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –ø–æ–ª—è–º–∏ id, name, artist, reason, match_score
- reasoning: –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
- confidence_score: —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö (0.0-1.0)

## –ü–†–ò–ù–¶–ò–ü–´ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô
- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
- –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –∑–Ω–∞–∫–æ–º—ã–º –∏ –Ω–æ–≤—ã–º
- –£—á–µ—Ç —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –†–∞–∑–≤–∏—Ç–∏–µ –º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
- –ö–∞—á–µ—Å—Ç–≤–æ –∏ —Ä–µ–ø—É—Ç–∞—Ü–∏—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
"""
        
        print("ü§ñ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ OpenRouter...")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ OpenRouter
        response = client.chat.completions.create(
            model="openai/gpt-4o-mini",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": "–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤–∏–Ω–∏–ª–æ–≤—ã—Ö –ø–ª–∞—Å—Ç–∏–Ω–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏."}
            ],
            temperature=0.7,
            max_tokens=2000
        )
        
        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
        llm_response = response.choices[0].message.content
        print("‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç OpenRouter")
        
        # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
        try:
            json_start = llm_response.find('{')
            json_end = llm_response.rfind('}') + 1
            if json_start != -1 and json_end != 0:
                json_str = llm_response[json_start:json_end]
                parsed_response = json.loads(json_str)
                print("‚úÖ JSON —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω –∏–∑ –æ—Ç–≤–µ—Ç–∞")
            else:
                parsed_response = {
                    "recommendations": [],
                    "reasoning": llm_response,
                    "confidence_score": 0.5
                }
                print("‚ö†Ô∏è JSON –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Å—å –æ—Ç–≤–µ—Ç –∫–∞–∫ reasoning")
        except json.JSONDecodeError as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}")
            parsed_response = {
                "recommendations": [],
                "reasoning": llm_response,
                "confidence_score": 0.3
            }
        
        # –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        print("\n" + "="*60)
        print("üéØ –†–ï–ó–£–õ–¨–¢–ê–¢–´ AI-–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô:")
        print(f"üìä –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å AI: {parsed_response.get('confidence_score', 0.5) * 100:.1f}%")
        print(f"üí≠ –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: {parsed_response.get('reasoning', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}")
        
        recommendations = parsed_response.get('recommendations', [])
        if recommendations:
            print(f"\nüíø –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –≤–∏–Ω–∏–ª–æ–≤—ã–µ –ø–ª–∞—Å—Ç–∏–Ω–∫–∏ ({len(recommendations)}):")
            for i, rec in enumerate(recommendations, 1):
                print(f"\n{i}. {rec.get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø–ª–∞—Å—Ç–∏–Ω–∫–∞')}")
                print(f"   –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: {rec.get('artist', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å')}")
                print(f"   –ü—Ä–∏—á–∏–Ω–∞: {rec.get('reason', '–ü–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –≤–∞—à–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è')}")
                if 'match_score' in rec:
                    print(f"   –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ: {rec['match_score'] * 100:.1f}%")
        else:
            print("\nüòî –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã")
        
        print("\n" + "="*60)
        print("üéâ –¢–µ—Å—Ç AI-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
        return True
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: {str(e)}")
        return False

async def test_recommender_service():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É —Å–µ—Ä–≤–∏—Å–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —á–µ—Ä–µ–∑ HTTP API"""
    print("\nüîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP API —Å–µ—Ä–≤–∏—Å–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π...")
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω
        async with httpx.AsyncClient() as client:
            response = await client.get("http://127.0.0.1:8004/health", timeout=5)
            if response.status_code == 200:
                print("‚úÖ –°–µ—Ä–≤–∏—Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –∑–∞–ø—É—â–µ–Ω")
            else:
                print(f"‚ùå –°–µ—Ä–≤–∏—Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –æ—Ç–≤–µ—á–∞–µ—Ç —Å –∫–æ–¥–æ–º {response.status_code}")
                return False
                
            # –¢–µ—Å—Ç–∏—Ä—É–µ–º —ç–Ω–¥–ø–æ–∏–Ω—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
            test_request = {
                "user_preferences": "–õ—é–±–ª—é –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ä–æ–∫ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Ä–æ–∫",
                "current_books": [1, 2],
                "genre_preferences": ["–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ä–æ–∫", "–ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Ä–æ–∫"],
                "max_recommendations": 3
            }
            
            print("üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API...")
            response = await client.post(
                "http://127.0.0.1:8004/api/v1/recommendations/generate",
                json=test_request,
                timeout=30
            )
            
            if response.status_code == 200:
                data = response.json()
                print("‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç API")
                print(f"üìä –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {data.get('confidence_score', 0) * 100:.1f}%")
                print(f"üí≠ –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: {data.get('reasoning', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')[:100]}...")
                print(f"üìö –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π: {len(data.get('recommendations', []))}")
                return True
            else:
                print(f"‚ùå API –≤–µ—Ä–Ω—É–ª –∫–æ–¥ {response.status_code}: {response.text}")
                return False
                
    except httpx.ConnectError:
        print("‚ùå –°–µ—Ä–≤–∏—Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–µ –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8004")
        print("   –ó–∞–ø—É—Å—Ç–∏—Ç–µ: start_recommender.bat")
        return False
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ API: {str(e)}")
        return False

async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    print("üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π\n")
    
    # –¢–µ—Å—Ç 1: –ü—Ä—è–º–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å OpenRouter
    direct_test_ok = await test_recommender_with_mock_data()
    
    # –¢–µ—Å—Ç 2: HTTP API —Å–µ—Ä–≤–∏—Å–∞
    api_test_ok = await test_recommender_service()
    
    print("\n" + "="*60)
    print("üìä –ò–¢–û–ì–û–í–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´:")
    print(f"   –ü—Ä—è–º–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ OpenRouter: {'‚úÖ –†–ê–ë–û–¢–ê–ï–¢' if direct_test_ok else '‚ùå –ù–ï –†–ê–ë–û–¢–ê–ï–¢'}")
    print(f"   HTTP API —Å–µ—Ä–≤–∏—Å–∞: {'‚úÖ –†–ê–ë–û–¢–ê–ï–¢' if api_test_ok else '‚ùå –ù–ï –†–ê–ë–û–¢–ê–ï–¢'}")
    
    if direct_test_ok:
        print("\nüéâ AI-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!")
        print("   –°–µ—Ä–≤–∏—Å –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!")
        return 0
    else:
        print("\n‚ö†Ô∏è –ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å AI-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏")
        return 1

if __name__ == "__main__":
    import sys
    sys.exit(asyncio.run(main()))
