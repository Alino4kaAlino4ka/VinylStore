# Тестирование корзины и заказов

## Описание

Создана страница корзины (`src/cart.html`) и логика оформления заказа (`src/scripts/cart.js`) для аудиокнижного магазина "Аудитерия".

## Файлы

### Frontend
- `src/cart.html` - Страница корзины с интерфейсом для просмотра товаров и оформления заказа
- `src/scripts/cart.js` - JavaScript логика для работы с корзиной и API

### Backend (обновлены)
- `services/cart/main.py` - Сервис корзины (порт 8001) с поддержкой CORS
- `services/orders/main.py` - Сервис заказов (порт 8002) с поддержкой CORS

### Тестирование
- `test_cart_functionality.html` - HTML страница для тестирования функциональности
- `test_cors_fix.html` - HTML страница для тестирования CORS исправлений

## Исправления CORS

### Проблема
При открытии HTML файлов напрямую в браузере возникала ошибка CORS:
```
Access to fetch at 'http://localhost:8001/api/v1/cart/calculate' from origin 'null' has been blocked by CORS policy
```

### Решение
Добавлена поддержка CORS в оба сервиса:

```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # В продакшене следует указать конкретные домены
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### Тестирование CORS
1. Откройте `test_cors_fix.html` в браузере
2. Нажмите кнопки для тестирования каждого сервиса
3. Проверьте, что все запросы проходят успешно
4. Откройте `src/cart.html` для полного тестирования

## Функциональность

### Страница корзины (`src/cart.html`)
- ✅ Базовая разметка с заголовком "Ваша корзина"
- ✅ Контейнер `<div id="cart-items"></div>` для товаров
- ✅ Итоговая сумма `<h3>Итого: <span id="total-price">0</span> ₽</h3>`
- ✅ Кнопка `<button id="checkout-btn">Оформить заказ</button>`
- ✅ Адаптивный дизайн в стиле сайта
- ✅ Обработка пустой корзины
- ✅ Отображение ошибок

### JavaScript логика (`src/scripts/cart.js`)
- ✅ При загрузке страницы читает ID товаров из `localStorage`
- ✅ Отправляет их на `POST /api/v1/cart/calculate` (сервис `cart` на порту 8001)
- ✅ Отрисовывает полученный список товаров и итоговую стоимость
- ✅ Обработчик на кнопку `checkout-btn`:
  - Читает `localStorage` и отправляет ID товаров на `POST /api/v1/orders` (сервис `orders` на порту 8002)
  - После успешного заказа очищает корзину в `localStorage`
  - Показывает `alert('Заказ успешно оформлен!')`
- ✅ Обработка ошибок и состояний загрузки

### API сервисы

#### Сервис корзины (порт 8001)
- `POST /api/v1/cart/calculate` - Расчет стоимости корзины
- Принимает: `{"product_ids": ["1", "2", "3"]}`
- Возвращает: `{"items": [...], "total": 1234.0}`

#### Сервис заказов (порт 8002)
- `POST /api/v1/orders` - Создание заказа
- Принимает: `{"product_ids": ["1", "2", "3"]}`
- Возвращает: `{"order_id": "uuid", "message": "Order created successfully", ...}`

## Запуск и тестирование

### 1. Запуск сервисов
```bash
# Запуск всех сервисов
start_all_services.bat

# Или по отдельности
start_cart.bat      # Порт 8001
start_orders.bat    # Порт 8002
```

### 2. Тестирование функциональности
1. Откройте `test_cart_functionality.html` в браузере
2. Добавьте товары в корзину
3. Протестируйте расчет корзины
4. Протестируйте создание заказа
5. Откройте `src/cart.html` для полного тестирования

### 3. Полный тест пользовательского сценария
1. Откройте `src/index.html`
2. Добавьте товары в корзину (кнопки "В корзину")
3. Перейдите в корзину по ссылке в навигации
4. Проверьте отображение товаров и суммы
5. Нажмите "Оформить заказ"
6. Проверьте успешное создание заказа и очистку корзины

## Моковые данные

Сервис корзины содержит моковые данные для товаров:
- `main-book` - "Гарри Поттер и Орден Феникса" - 199₽
- `promo-book` - "Линкольн для адвоката" - 299₽
- `1` - "Крестный отец" - 249₽
- `2` - "Тени прошлого" - 199₽
- `3` - "Алмазная колесница" - 349₽
- `4` - "Бруклин" - 179₽
- `5` - "Изгой" - 229₽

## Особенности реализации

- Используется `localStorage` для хранения корзины
- Обработка ошибок сети и API
- Адаптивный дизайн
- Состояния загрузки и ошибок
- Автоматическое обновление счетчика корзины
- Проверка авторизации пользователя
- Валидация данных на клиенте и сервере
